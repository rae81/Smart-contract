# Nginx reverse proxy for IPFS with mTLS
# Provides secure access to IPFS API using Fabric CA certificates

events {
    worker_connections 1024;
}

http {
    # Upstream IPFS API
    upstream ipfs_api {
        server ipfs-node:5001;
    }

    # Upstream IPFS Gateway
    upstream ipfs_gateway {
        server ipfs-node:8080;
    }

    # IPFS API with mTLS (port 5443)
    server {
        listen 5443 ssl;
        server_name ipfs-node;

        # Server certificate (issued by Fabric CA)
        ssl_certificate /etc/nginx/certs/server.crt;
        ssl_certificate_key /etc/nginx/certs/server.key;

        # Client certificate verification (mTLS)
        ssl_client_certificate /etc/nginx/certs/ca.crt;
        ssl_verify_client on;
        ssl_verify_depth 2;

        # TLS configuration
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers HIGH:!aNULL:!MD5;
        ssl_prefer_server_ciphers on;

        # Proxy to IPFS API
        location / {
            proxy_pass http://ipfs_api;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # IPFS API requires these
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_buffering off;

            # Increase timeouts for large file uploads
            proxy_read_timeout 300s;
            proxy_send_timeout 300s;
        }

        # Access log with client cert info
        access_log /var/log/nginx/ipfs-api-access.log combined;
        error_log /var/log/nginx/ipfs-api-error.log warn;
    }

    # IPFS Gateway with TLS (port 8443)
    server {
        listen 8443 ssl;
        server_name ipfs-node;

        # Server certificate
        ssl_certificate /etc/nginx/certs/server.crt;
        ssl_certificate_key /etc/nginx/certs/server.key;

        # Client certificate verification (mTLS)
        ssl_client_certificate /etc/nginx/certs/ca.crt;
        ssl_verify_client on;
        ssl_verify_depth 2;

        # TLS configuration
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers HIGH:!aNULL:!MD5;
        ssl_prefer_server_ciphers on;

        # Proxy to IPFS Gateway
        location / {
            proxy_pass http://ipfs_gateway;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_http_version 1.1;
            proxy_buffering off;
        }

        access_log /var/log/nginx/ipfs-gateway-access.log combined;
        error_log /var/log/nginx/ipfs-gateway-error.log warn;
    }
}
